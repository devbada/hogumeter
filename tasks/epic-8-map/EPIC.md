# Epic 8: 지도보기 기능

## 📋 Epic 정보

| 항목 | 내용 |
|------|------|
| Epic ID | EPIC-8 |
| Epic 명 | 지도보기 기능 |
| 우선순위 | P1 (Should) |
| 예상 기간 | Week 4-5 |
| 상태 | 🔲 대기 |
| 생성일 | 2025-01-15 |

---

## 🎯 Epic 목표

사용자가 미터기 작동 중 실시간으로 지도에서 현재 위치와 이동 경로를 확인할 수 있는 지도보기 기능 제공. 재미있는 "택시+말" 아이콘으로 현재 위치를 표시하고, GPS 이동 경로를 시각적으로 보여줌.

---

## 📖 요구사항 정의서

### 1. 개요

#### 1.1 기능 목적
- 미터기 작동 중 실시간 위치 및 이동 경로 시각화
- 재미있는 UX를 위한 커스텀 위치 마커 ("택시+말" 아이콘)
- 요금 및 속도 정보를 지도 화면에서도 확인 가능

#### 1.2 사용 시나리오
```
1. 사용자가 메인 화면에서 "지도보기" 버튼 탭
2. 지도 화면으로 전환, 현재 위치에 "택시+말" 마커 표시
3. "시작하기" 버튼 탭 → 미터기 시작 + 이동 경로 그리기 시작
4. 이동하면서 실시간으로 경로가 지도에 표시됨
5. 하단에 현재 요금, 속도, 거리, 시간 정보 표시
6. "정지" 버튼 탭 → 미터기 정지, 최종 경로 표시
7. 메인 화면으로 돌아가거나 영수증 확인
```

---

### 2. 기능 요구사항 (Functional Requirements)

#### FR-8.1: 지도 화면 진입

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| FR-8.1.1 | 메인 화면에 "지도보기" 버튼 제공 | P0 |
| FR-8.1.2 | 버튼 탭 시 지도 화면으로 전환 | P0 |
| FR-8.1.3 | 지도는 Apple Maps (MapKit) 사용 | P0 |
| FR-8.1.4 | 지도 화면 진입 시 현재 위치 중심으로 표시 | P0 |
| FR-8.1.5 | 위치 권한 없을 시 권한 요청 안내 | P0 |

#### FR-8.2: 커스텀 위치 마커

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| FR-8.2.1 | 현재 위치에 "택시+말" 커스텀 마커 표시 | P0 |
| FR-8.2.2 | 마커는 이동 방향으로 회전 | P1 |
| FR-8.2.3 | 속도에 따라 마커 애니메이션 변화 | P2 |
| FR-8.2.4 | 마커 크기: 50x50pt (조절 가능) | P1 |

#### FR-8.3: 이동 경로 표시

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| FR-8.3.1 | 미터기 시작 시 경로 그리기 시작 | P0 |
| FR-8.3.2 | GPS 좌표를 연결하여 폴리라인(Polyline) 표시 | P0 |
| FR-8.3.3 | 경로 선 색상: 메인 테마 컬러 (파란색 계열) | P0 |
| FR-8.3.4 | 경로 선 두께: 4pt | P1 |
| FR-8.3.5 | 시작 지점에 출발 마커 표시 | P1 |
| FR-8.3.6 | 정지 시 도착 지점에 도착 마커 표시 | P1 |
| FR-8.3.7 | 경로가 화면에 보이도록 자동 줌 조절 (옵션) | P2 |

#### FR-8.4: 하단 정보 패널

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| FR-8.4.1 | 지도 하단에 정보 패널 표시 | P0 |
| FR-8.4.2 | 현재 요금 실시간 표시 | P0 |
| FR-8.4.3 | 현재 속도 표시 (km/h) | P0 |
| FR-8.4.4 | 이동 거리 표시 (km) | P0 |
| FR-8.4.5 | 경과 시간 표시 (HH:MM:SS) | P0 |
| FR-8.4.6 | 시작/정지 버튼 제공 | P0 |
| FR-8.4.7 | 패널 접기/펼치기 기능 | P2 |

#### FR-8.5: 지도 컨트롤

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| FR-8.5.1 | 현재 위치로 이동 버튼 | P0 |
| FR-8.5.2 | 확대/축소 제스처 지원 | P0 |
| FR-8.5.3 | 지도 이동 (패닝) 지원 | P0 |
| FR-8.5.4 | 지도 타입 변경 (일반/위성/하이브리드) | P2 |
| FR-8.5.5 | 나침반 표시 | P2 |

---

### 3. 비기능 요구사항 (Non-Functional Requirements)

#### NFR-8.1: 성능

| ID | 요구사항 | 기준 |
|----|----------|------|
| NFR-8.1.1 | 지도 로딩 시간 | < 2초 |
| NFR-8.1.2 | 경로 업데이트 주기 | 1초 |
| NFR-8.1.3 | 마커 이동 애니메이션 | 60fps |
| NFR-8.1.4 | 경로 포인트 최대 개수 | 10,000개 |

#### NFR-8.2: 배터리

| ID | 요구사항 | 기준 |
|----|----------|------|
| NFR-8.2.1 | 지도 화면 1시간 사용 시 배터리 소모 | < 20% |
| NFR-8.2.2 | 백그라운드에서 경로 기록 유지 | 지원 |

#### NFR-8.3: UX

| ID | 요구사항 | 기준 |
|----|----------|------|
| NFR-8.3.1 | 지도 조작 반응 시간 | < 100ms |
| NFR-8.3.2 | 다크모드 지원 | 필수 |
| NFR-8.3.3 | 가로/세로 모드 | 세로 고정 |

---

### 4. 화면 설계

#### 4.1 지도보기 전체 화면

```
┌─────────────────────────────────────────┐
│ ← 지도보기                    [지도타입] │
├─────────────────────────────────────────┤
│                                         │
│                                         │
│         ┌─────────────────┐             │
│         │    🗺️ 지도       │             │
│         │                 │             │
│         │    ~~~경로~~~   │             │
│         │        \        │             │
│         │         \       │             │
│         │          🚕🐴   │ ← 현재 위치  │
│         │                 │             │
│         └─────────────────┘             │
│                                         │
│                              ◎ ← 내 위치 │
│                                         │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐    │
│  │                                 │    │
│  │   💰 12,400원        🚗 45 km/h │    │
│  │                                 │    │
│  │   📍 5.2 km         ⏱️ 00:15:32 │    │
│  │                                 │    │
│  │   ┌───────────┐ ┌───────────┐   │    │
│  │   │   시작    │ │   리셋    │   │    │
│  │   └───────────┘ └───────────┘   │    │
│  │                                 │    │
│  └─────────────────────────────────┘    │
│                                         │
└─────────────────────────────────────────┘
```

#### 4.2 미터기 작동 중 화면

```
┌─────────────────────────────────────────┐
│ ← 지도보기              🌙 야간할증 ON  │
├─────────────────────────────────────────┤
│                                         │
│     📍 출발                             │
│      ●                                  │
│       \                                 │
│        \                                │
│         ~~~~~~~~                        │
│                 \                       │
│                  \                      │
│                   ~~~~~~~~              │
│                           \             │
│                            🚕🐴         │
│                         (현재 위치)      │
│                                         │
│                              ◎          │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐    │
│  │                                 │    │
│  │   💰 24,800원        🚗 67 km/h │    │
│  │   ────────────────────────────  │    │
│  │   📍 12.5 km        ⏱️ 00:23:45 │    │
│  │                                 │    │
│  │   ┌───────────┐ ┌───────────┐   │    │
│  │   │   정지    │ │  메인으로  │   │    │
│  │   └───────────┘ └───────────┘   │    │
│  │                                 │    │
│  └─────────────────────────────────┘    │
│                                         │
└─────────────────────────────────────────┘
```

#### 4.3 하단 패널 상세

```
┌─────────────────────────────────────────┐
│  ═══════════════════════════════════    │  ← 드래그 핸들 (접기/펼치기)
│                                         │
│     💰 24,800원             🚗 67 km/h  │
│     ───────────────────────────────     │
│     현재 요금                 현재 속도  │
│                                         │
│     📍 12.5 km             ⏱️ 00:23:45  │
│     ───────────────────────────────     │
│     이동 거리                 경과 시간  │
│                                         │
│  ┌──────────────────┐ ┌──────────────┐  │
│  │                  │ │              │  │
│  │    🛑 정지       │ │  🏠 메인으로  │  │
│  │                  │ │              │  │
│  └──────────────────┘ └──────────────┘  │
│                                         │
└─────────────────────────────────────────┘
```

#### 4.4 택시+말 커스텀 마커

```
     ┌─────────────┐
     │   🚕        │
     │  ╱  ╲       │
     │ 🐴   ╲      │   ← 택시 위에 말이 올라탄 모습
     │      ═══    │      또는 택시 옆에 말이 달리는 모습
     └─────────────┘
     
     [디자인 옵션]
     
     옵션 A: 택시 안에 말이 운전하는 모습
     ┌─────┐
     │🐴🚕│
     └─────┘
     
     옵션 B: 말이 택시를 끄는 모습
     🐴═══🚕
     
     옵션 C: 택시 위에 말이 서있는 모습 (추천)
       🐴
      ┌──┐
      │🚕│
      └──┘
```

---

### 5. 데이터 구조

#### 5.1 경로 데이터

```swift
/// 단일 경로 포인트
struct RoutePoint: Codable, Identifiable {
    let id: UUID
    let coordinate: CLLocationCoordinate2D
    let timestamp: Date
    let speed: Double           // m/s
    let altitude: Double        // m
    let accuracy: Double        // m
}

/// 전체 경로
struct Route: Codable, Identifiable {
    let id: UUID
    var points: [RoutePoint]
    var startTime: Date
    var endTime: Date?
    
    var totalDistance: Double {
        // 포인트 간 거리 합산
    }
    
    var coordinates: [CLLocationCoordinate2D] {
        points.map { $0.coordinate }
    }
}
```

#### 5.2 지도 상태

```swift
/// 지도 화면 상태
enum MapViewState {
    case idle           // 대기 (미터기 시작 전)
    case tracking       // 추적 중 (미터기 작동 중)
    case stopped        // 정지됨 (미터기 정지 후)
    case reviewing      // 경로 리뷰 중
}

/// 지도 타입
enum MapDisplayType: String, CaseIterable {
    case standard = "standard"      // 일반
    case satellite = "satellite"    // 위성
    case hybrid = "hybrid"          // 하이브리드
    
    var displayName: String {
        switch self {
        case .standard: return "일반"
        case .satellite: return "위성"
        case .hybrid: return "하이브리드"
        }
    }
}
```

---

### 6. 기술 스택

| 구성요소 | 기술 | 비고 |
|---------|------|------|
| 지도 프레임워크 | MapKit | iOS 기본 |
| 위치 서비스 | Core Location | 기존 LocationService 활용 |
| 경로 렌더링 | MKPolyline, MKPolylineRenderer | |
| 커스텀 마커 | MKAnnotationView | 커스텀 이미지 사용 |
| UI | SwiftUI + UIViewRepresentable | MapKit 래핑 |

---

### 7. 의존성

#### 7.1 선행 Task
- TASK-1.0: 백그라운드 GPS 권한 설정
- TASK-1.3: GPS 위치 추적
- TASK-1.2: 요금 계산 로직

#### 7.2 연관 Task
- TASK-2.1: 말 속도별 애니메이션 (마커 애니메이션 연동 가능)

---

## 📝 Story 목록

| Story ID | 제목 | 우선순위 | 예상 시간 |
|----------|------|----------|----------|
| STORY-8.1 | 지도 화면 기본 구조 | P0 | 3시간 |
| STORY-8.2 | 커스텀 위치 마커 (택시+말) | P0 | 2시간 |
| STORY-8.3 | 이동 경로 폴리라인 표시 | P0 | 3시간 |
| STORY-8.4 | 하단 정보 패널 UI | P0 | 2시간 |
| STORY-8.5 | 지도 컨트롤 (내 위치, 줌) | P1 | 2시간 |
| STORY-8.6 | 마커 방향 회전 | P1 | 1시간 |
| STORY-8.7 | 출발/도착 마커 | P1 | 1시간 |
| STORY-8.8 | 지도 타입 변경 | P2 | 1시간 |
| STORY-8.9 | 패널 접기/펼치기 | P2 | 1시간 |
| STORY-8.10 | 마커 속도 연동 애니메이션 | P2 | 2시간 |

---

## ✅ 수락 기준 (Epic 전체)

- [ ] 메인 화면에서 지도보기 화면으로 진입 가능
- [ ] 지도에 현재 위치가 "택시+말" 마커로 표시됨
- [ ] 미터기 시작 시 이동 경로가 실시간으로 그려짐
- [ ] 하단 패널에 요금, 속도, 거리, 시간 정보 표시
- [ ] 시작/정지 버튼으로 미터기 제어 가능
- [ ] 60fps 부드러운 마커 이동
- [ ] 배터리 소모 1시간 20% 이내

---

## 📝 구현 노트

(개발 중 기록)

---

## 🐛 발견된 이슈

(개발 중 기록)

---

## 📎 참고 자료

- [Apple MapKit Documentation](https://developer.apple.com/documentation/mapkit)
- [MKPolyline Tutorial](https://developer.apple.com/documentation/mapkit/mkpolyline)
- [Custom MKAnnotationView](https://developer.apple.com/documentation/mapkit/mkannotationview)
- docs/ARCHITECTURE.md - LocationService
- docs/DEVELOPMENT_GUIDE-FOR-AI.md - Development Guide
