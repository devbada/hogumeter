# Epic 8: 지도보기 기능 (Map View)

## 📋 Epic 정보

| 항목 | 내용 |
|------|------|
| Epic ID | EPIC-8 |
| Epic 명 | 지도보기 기능 |
| 우선순위 | P1 (Should) |
| 예상 기간 | Week 4-5 |
| 상태 | 🔲 대기 |
| 생성일 | 2025-01-15 |

---

## 🎯 Epic 목표

사용자가 미터기 작동 중 지도 화면으로 전환하여 실시간 위치와 이동 경로를 시각적으로 확인할 수 있는 기능 제공. 재미있는 "택시+말" 아이콘으로 현재 위치를 표시하고, GPS 경로를 선으로 그려 이동 궤적을 보여줌.

---

## 📖 기능 개요

### 핵심 기능

| 기능 | 설명 |
|------|------|
| 지도 표시 | Apple Maps (MapKit) 기반 지도 화면 |
| 위치 마커 | 🚕🐴 택시+말 커스텀 마커로 현재 위치 표시 |
| 경로 그리기 | GPS 이동 경로를 실시간 폴리라인으로 표시 |
| 요금/속도 표시 | 화면 하단에 현재 요금, 속도 정보 오버레이 |
| 화면 전환 | 미터기 화면 ↔ 지도 화면 간 전환 |

### 사용자 스토리

> **운전자로서**, 미터기 작동 중에 지도를 보면서 어디를 지나왔는지 확인하고 싶다.
> 그래야 친구에게 "우리 여기 다 지나왔어! 돈 내놔!" 하고 보여줄 수 있다. 🐴

---

## 🎨 화면 설계

### 1. 지도 화면 전체 구조

```
┌─────────────────────────────────────────┐
│ ← 미터기          지도보기        📍    │
├─────────────────────────────────────────┤
│                                         │
│                                         │
│         ┌─────────────────┐             │
│         │                 │             │
│         │    Apple Map    │             │
│         │                 │             │
│         │                 │             │
│         │   ~~~~~~~~~~~~  │             │
│         │  /              │             │
│         │ /    🚕🐴       │  ← 현재 위치 │
│         │/     (말 택시)   │             │
│         │                 │             │
│         │  ○ 출발지       │             │
│         │                 │             │
│         └─────────────────┘             │
│                                         │
│                                         │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐    │
│  │  💰 12,400원    🚗 45 km/h      │    │
│  │  📍 5.2 km     ⏱️ 00:15:32     │    │
│  └─────────────────────────────────┘    │
│                                         │
│  ┌─────────────────────────────────┐    │
│  │          ⏹️ 정지하기            │    │
│  └─────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

### 2. 커스텀 위치 마커 (택시+말)

```
     🐴
   ┌────┐
   │🚕  │ ← 택시 아이콘 위에 말이 올라탄 모습
   └────┘
     ▼
   (현재 위치)

* 이동 방향에 따라 마커 회전
* 속도에 따라 말 애니메이션 변화 (선택)
```

### 3. 경로 폴리라인

```
    ○ 출발지 (초록색 마커)
    │
    │  ← 이동 경로 (파란색/보라색 선)
    │
    ├──────┐
    │      │
    │      │
    │      └────────┐
    │               │
    └───────────────┤
                    │
                🚕🐴 현재 위치
```

### 4. 하단 정보 오버레이

```
┌─────────────────────────────────────────┐
│                                         │
│  ┌───────────────┬───────────────┐      │
│  │  💰 12,400원  │  🚗 45 km/h   │      │
│  ├───────────────┼───────────────┤      │
│  │  📍 5.2 km    │  ⏱️ 00:15:32  │      │
│  └───────────────┴───────────────┘      │
│                                         │
│  ┌─────────────────────────────────┐    │
│  │          ⏹️ 정지하기            │    │
│  └─────────────────────────────────┘    │
│                                         │
└─────────────────────────────────────────┘

* 반투명 배경으로 지도 위에 오버레이
* 정보는 실시간 업데이트
* "정지하기" 버튼으로 미터기 종료 가능
```

---

## 📝 기능 요구사항 (Functional Requirements)

### FR-8.1: 지도 화면 표시

| 항목 | 내용 |
|------|------|
| ID | FR-8.1 |
| 제목 | 지도 화면 표시 |
| 우선순위 | P0 |
| 설명 | Apple Maps (MapKit) 기반 지도를 전체 화면으로 표시 |

**수락 기준:**
- [ ] MapKit을 사용하여 지도 표시
- [ ] 현재 위치 중심으로 지도 초기화
- [ ] 줌 인/아웃, 스크롤 제스처 지원
- [ ] 지도 유형 선택 가능 (표준/위성/하이브리드) - 선택
- [ ] 현재 위치로 이동 버튼 (📍)

---

### FR-8.2: 커스텀 위치 마커 (택시+말)

| 항목 | 내용 |
|------|------|
| ID | FR-8.2 |
| 제목 | 커스텀 위치 마커 |
| 우선순위 | P0 |
| 설명 | 현재 위치를 "택시+말" 커스텀 아이콘으로 표시 |

**수락 기준:**
- [ ] 🚕🐴 형태의 커스텀 마커 표시
- [ ] 마커가 현재 GPS 위치에 실시간 업데이트
- [ ] 이동 방향에 따라 마커 회전 (heading)
- [ ] 속도에 따라 마커 애니메이션 변화 (선택)
- [ ] 마커 크기 적절히 조정 (너무 크거나 작지 않게)

**마커 디자인 옵션:**
```
Option A: 이모지 조합
   🐴
  🚕

Option B: 커스텀 이미지
  ┌─────┐
  │ 🐴  │
  │🚕   │
  └──▼──┘

Option C: 애니메이션 마커 (Lottie)
  - 말이 달리는 애니메이션
  - 속도에 따라 빠르기 변화
```

---

### FR-8.3: GPS 경로 그리기

| 항목 | 내용 |
|------|------|
| ID | FR-8.3 |
| 제목 | GPS 경로 폴리라인 |
| 우선순위 | P0 |
| 설명 | 미터기 시작부터 현재까지 이동 경로를 선으로 표시 |

**수락 기준:**
- [ ] 출발 지점에 시작 마커 표시 (○ 초록색)
- [ ] 이동 경로를 MKPolyline으로 그리기
- [ ] 실시간으로 경로 업데이트 (새 좌표 추가)
- [ ] 경로선 색상: 파란색 또는 보라색
- [ ] 경로선 두께: 4-6pt
- [ ] 경로가 화면에 맞게 자동 줌 조정 (선택)

**경로 데이터 구조:**
```swift
struct RoutePoint: Codable {
    let coordinate: CLLocationCoordinate2D
    let timestamp: Date
    let speed: Double       // km/h
    let accuracy: Double    // meters
}

// 경로 저장
var routePoints: [RoutePoint] = []
```

---

### FR-8.4: 하단 정보 오버레이

| 항목 | 내용 |
|------|------|
| ID | FR-8.4 |
| 제목 | 하단 정보 오버레이 |
| 우선순위 | P0 |
| 설명 | 지도 화면 하단에 현재 요금, 속도, 거리, 시간 표시 |

**수락 기준:**
- [ ] 반투명 배경의 정보 패널
- [ ] 표시 정보: 현재 요금, 현재 속도, 총 거리, 주행 시간
- [ ] 실시간 업데이트 (1초 간격)
- [ ] "정지하기" 버튼 포함
- [ ] 정보 패널 높이 조절 가능 (선택)

---

### FR-8.5: 화면 전환

| 항목 | 내용 |
|------|------|
| ID | FR-8.5 |
| 제목 | 미터기 ↔ 지도 화면 전환 |
| 우선순위 | P0 |
| 설명 | 미터기 화면과 지도 화면 간 자유로운 전환 |

**수락 기준:**
- [ ] 미터기 화면에서 "지도보기" 버튼 탭 → 지도 화면 이동
- [ ] 지도 화면에서 "← 미터기" 버튼 탭 → 미터기 화면 복귀
- [ ] 화면 전환 중에도 미터기 계속 작동 (백그라운드)
- [ ] 부드러운 전환 애니메이션

---

### FR-8.6: 현재 위치 버튼

| 항목 | 내용 |
|------|------|
| ID | FR-8.6 |
| 제목 | 현재 위치로 이동 버튼 |
| 우선순위 | P1 |
| 설명 | 지도를 스크롤한 후 현재 위치로 빠르게 돌아오기 |

**수락 기준:**
- [ ] 우측 상단에 📍 버튼 표시
- [ ] 버튼 탭 시 현재 위치로 지도 중심 이동
- [ ] 부드러운 애니메이션으로 이동
- [ ] 현재 위치 추적 모드 토글 (선택)

---

## 📐 비기능 요구사항 (Non-Functional Requirements)

### NFR-8.1: 성능

| 항목 | 목표 |
|------|------|
| 지도 로딩 시간 | < 2초 |
| 마커 업데이트 주기 | 1초 |
| 경로 렌더링 성능 | 1000+ 포인트에서도 60fps 유지 |
| 메모리 사용량 | < 50MB 추가 |

### NFR-8.2: 배터리

| 항목 | 목표 |
|------|------|
| 지도 화면 추가 배터리 소모 | < 5% / 시간 |
| GPS 업데이트 주기 최적화 | 화면 off 시 저전력 모드 |

### NFR-8.3: 정확도

| 항목 | 목표 |
|------|------|
| 위치 마커 정확도 | GPS 정확도 따름 |
| 경로 그리기 정확도 | 10m 이내 오차 |
| 방향 (heading) 정확도 | ±15° |

---

## 🔧 기술 설계

### 사용 기술

| 기술 | 용도 |
|------|------|
| MapKit | 지도 표시 |
| MKMapView | 지도 뷰 |
| MKAnnotationView | 커스텀 마커 |
| MKPolyline | 경로 그리기 |
| MKPolylineRenderer | 경로 스타일링 |
| Core Location | GPS 데이터 |

### 데이터 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                     LocationService                          │
│                           │                                  │
│                           ▼                                  │
│                    CLLocation                                │
│                    (coordinate, speed, heading)              │
└─────────────────────────────────────────────────────────────┘
                            │
            ┌───────────────┼───────────────┐
            ▼               ▼               ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ MeterViewModel│ │ MapViewModel │ │RouteManager │
    │              │ │              │ │              │
    │ - 요금 계산   │ │ - 마커 위치  │ │ - 경로 저장  │
    │ - 속도 표시   │ │ - 지도 중심  │ │ - 폴리라인   │
    └──────────────┘ └──────────────┘ └──────────────┘
            │               │               │
            └───────────────┼───────────────┘
                            ▼
                    ┌──────────────┐
                    │   MapView    │
                    │              │
                    │ - 지도 표시   │
                    │ - 마커 표시   │
                    │ - 경로 표시   │
                    │ - 정보 오버레이│
                    └──────────────┘
```

### 프로젝트 구조 (추가)

```
Presentation/
├── Views/
│   ├── Map/
│   │   ├── MapContainerView.swift        # 지도 컨테이너
│   │   ├── TaxiHorseAnnotationView.swift # 커스텀 마커
│   │   ├── RouteOverlayView.swift        # 경로 오버레이
│   │   └── Components/
│   │       ├── MapInfoOverlayView.swift  # 하단 정보 패널
│   │       ├── MapControlsView.swift     # 지도 컨트롤 버튼
│   │       └── StartMarkerView.swift     # 출발 마커
│   │
│   └── Main/
│       └── MainMeterView.swift           # 지도보기 버튼 추가
│
├── ViewModels/
│   └── MapViewModel.swift                # 지도 ViewModel
│
Domain/
├── Entities/
│   └── RoutePoint.swift                  # 경로 포인트 엔티티
│
├── Services/
│   └── RouteManager.swift                # 경로 관리 서비스
│
Resources/
├── Assets.xcassets/
│   └── Images/
│       ├── taxi_horse_marker.imageset/   # 택시+말 마커 이미지
│       └── start_marker.imageset/        # 출발 마커 이미지
```

---

## 📋 Task 분해

### Task 목록

| Task ID | 제목 | 우선순위 | 예상 시간 | 의존성 |
|---------|------|----------|----------|--------|
| TASK-8.1 | 지도 화면 기본 구조 | P0 | 2시간 | - |
| TASK-8.2 | 커스텀 마커 (택시+말) | P0 | 3시간 | TASK-8.1 |
| TASK-8.3 | GPS 경로 폴리라인 | P0 | 4시간 | TASK-8.1 |
| TASK-8.4 | 하단 정보 오버레이 | P0 | 2시간 | TASK-8.1 |
| TASK-8.5 | 화면 전환 연동 | P0 | 2시간 | TASK-8.1~8.4 |
| TASK-8.6 | 현재 위치 버튼 | P1 | 1시간 | TASK-8.1 |
| TASK-8.7 | 마커 애니메이션 (선택) | P2 | 3시간 | TASK-8.2 |

### Task 상세

```
TASK-8.1: 지도 화면 기본 구조
├── MapContainerView 생성
├── MKMapView 연동 (UIViewRepresentable)
├── MapViewModel 생성
├── 지도 초기 위치 설정
└── 기본 제스처 (줌, 스크롤) 확인

TASK-8.2: 커스텀 마커 (택시+말)
├── 택시+말 마커 이미지 에셋 추가
├── TaxiHorseAnnotationView 구현
├── MKAnnotation 커스텀
├── 마커 위치 실시간 업데이트
└── 마커 회전 (heading) 적용

TASK-8.3: GPS 경로 폴리라인
├── RoutePoint 엔티티 정의
├── RouteManager 서비스 구현
├── MKPolyline 그리기
├── MKPolylineRenderer 스타일링
├── 실시간 경로 업데이트
└── 출발 마커 표시

TASK-8.4: 하단 정보 오버레이
├── MapInfoOverlayView 구현
├── 요금, 속도, 거리, 시간 표시
├── MeterViewModel 연동
├── 정지하기 버튼 추가
└── 반투명 배경 스타일링

TASK-8.5: 화면 전환 연동
├── MainMeterView에 지도보기 버튼 추가
├── NavigationStack 또는 Sheet 전환
├── 전환 중 미터기 상태 유지
└── 전환 애니메이션

TASK-8.6: 현재 위치 버튼
├── 📍 버튼 UI 추가
├── 현재 위치로 지도 이동 기능
└── 추적 모드 토글 (선택)

TASK-8.7: 마커 애니메이션 (선택)
├── 속도별 마커 이미지 변경
├── 말 달리기 애니메이션
└── Lottie 또는 스프라이트 적용
```

---

## 🧪 테스트 시나리오

### 시나리오 1: 지도 화면 진입

1. 미터기 시작 상태
2. "지도보기" 버튼 탭
3. 지도 화면으로 전환
4. 현재 위치에 택시+말 마커 표시
5. 하단에 요금/속도 정보 표시

### 시나리오 2: 경로 그리기

1. 미터기 시작
2. 지도 화면 진입
3. 차량 이동 (시뮬레이터에서 위치 시뮬레이션)
4. 이동 경로가 파란색 선으로 그려짐
5. 마커가 실시간으로 이동

### 시나리오 3: 마커 회전

1. 지도 화면에서 차량 이동
2. 진행 방향에 따라 마커 회전
3. 유턴 시 마커가 반대 방향으로 회전

### 시나리오 4: 화면 전환

1. 미터기 화면 → 지도 화면 전환
2. 지도 화면에서 요금 확인
3. "← 미터기" 버튼으로 복귀
4. 미터기가 계속 작동 중인지 확인

### 시나리오 5: 지도에서 미터기 정지

1. 지도 화면에서 "정지하기" 버튼 탭
2. 미터기 정지
3. 최종 요금 표시
4. 미터기 화면으로 자동 복귀 또는 영수증 표시

---

## ✅ 완료 기준

- [ ] 지도 화면이 정상 표시됨
- [ ] 택시+말 마커가 현재 위치에 표시됨
- [ ] 이동 경로가 폴리라인으로 그려짐
- [ ] 하단에 요금/속도 정보가 실시간 업데이트됨
- [ ] 미터기 ↔ 지도 화면 전환이 원활함
- [ ] 화면 전환 중에도 미터기가 정상 작동함
- [ ] 60fps 성능 유지
- [ ] 메모리 누수 없음

---

## 📝 구현 노트

(개발 중 기록)

---

## 🐛 발견된 이슈

(개발 중 기록)

---

## 📎 참고 자료

- [Apple MapKit Documentation](https://developer.apple.com/documentation/mapkit)
- [MKAnnotationView Customization](https://developer.apple.com/documentation/mapkit/mkannotationview)
- [MKPolyline & MKPolylineRenderer](https://developer.apple.com/documentation/mapkit/mkpolyline)
- docs/ARCHITECTURE.md - Section 4 Core Components
- docs/PRD.md - Epic 관련 섹션
- docs/DEVELOPMENT_GUIDE-FOR-AI.md - Development Guide
