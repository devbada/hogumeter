# Feature Specification: Regional Surcharge Mode (지역 할증 모드)

**Task ID:** SURCHARGE-001
**Created:** 2025-01-14
**Completed:** 2026-01-14
**Branch:** feature/regional-surcharge-mode
**Version:** 1.1.0
**Status:** ✅ Completed

---

## 목표

실제 택시의 시계외 할증 기준을 반영한 '리얼 모드'와 기존의 '재미 모드' 중 선택 가능하도록 구현

## 실제 택시 시계외 할증 기준

### 핵심 원칙

1. **적용 시점**: 사업구역 경계를 벗어나는 순간부터 (출발 시부터 X)
2. **적용 대상**: 경계를 벗어난 구간의 요금만 할증
3. **적용 조건**: 최종 목적지가 사업구역 밖일 경우에만 (앱에서는 현재 위치 기준으로 근사)

### 도시별 할증률

| 도시 | 일반(중형) | 심야+시계외 중복 |
|------|-----------|------------------|
| 서울 | 20% | 최대 60% |
| 부산 | 30% | 40~50% |
| 인천 | 30% | 중복 적용 |
| 경기도 | 20% | 중복 적용 |
| 대구 | 20% | - |
| 광주 | 20% | - |
| 대전 | 30% | 40% |
| 울산 | 20% | - |

### 서울 특수 구역 (할증 미적용)

- **통합사업구역**: 광명시
- **공동사업구역**: 위례신도시 (송파구/성남시/하남시 위례동)

---

## 기능 요구사항

### 1. 지역 할증 모드 설정

3가지 모드 제공:

| 모드 | 설명 |
|------|------|
| 리얼 모드 🚕 | 실제 택시처럼 사업구역(시/도) 경계를 벗어날 때만 할증 |
| 재미 모드 🎮 | 동네(동/읍/면)가 바뀔 때마다 할증 (기존 방식) |
| 끄기 | 지역 할증 미적용 |

### 2. 리얼 모드 로직

```
1. 미터기 시작 시 출발지의 사업구역(시/도) 기록
2. GPS 업데이트마다 현재 위치의 시/도 확인
3. 출발지 사업구역을 벗어나면 → 할증 시작 (isSurchargeActive = true)
4. 출발지 사업구역으로 돌아오면 → 할증 해제
5. 특수 구역 예외 처리:
   - 서울 출발 → 광명시: 할증 없음
   - 서울 출발 → 위례동: 할증 없음
```

### 3. 할증 적용 방식

- **리얼 모드**: 사업구역 밖에 있는 동안 발생하는 요금에만 할증률 적용
- **재미 모드**: 동 변경 횟수 × 고정 금액 (기존 방식)

---

## 기술 설계

### 신규 파일

| 파일 | 위치 | 설명 |
|------|------|------|
| RegionalSurchargeMode.swift | Domain/Entities/ | 모드 enum |
| RegionalSurchargeService.swift | Domain/Services/ | 할증 로직 서비스 |
| RegionalSurchargeModeView.swift | Presentation/Views/Settings/ | 모드 선택 UI |
| RegionalSurchargeServiceTests.swift | HoguMeterTests/Unit/ | 단위 테스트 |

### 수정 파일

| 파일 | 변경 내용 |
|------|-----------|
| SettingsRepository.swift | regionalSurchargeMode 속성 추가 |
| SettingsView.swift | 모드 선택 네비게이션 추가 |
| FareCalculator.swift | 리얼 모드 할증 계산 로직 추가 |
| MeterViewModel.swift | RegionalSurchargeService 통합 |
| project.pbxproj | 버전 1.1.0, 새 파일 참조 |

---

## 테스트 케이스

### 리얼 모드 테스트

| 시나리오 | 출발지 | 현재 위치 | 예상 결과 |
|----------|--------|-----------|-----------|
| 서울 내 이동 | 서울 강남구 | 서울 송파구 | 할증 없음 |
| 서울→경기 | 서울 강남구 | 경기 성남시 | 20% 할증 |
| 서울→광명 | 서울 금천구 | 경기 광명시 | 할증 없음 (특수구역) |
| 서울→위례 | 서울 송파구 | 성남시 위례동 | 할증 없음 (특수구역) |
| 부산→경남 | 부산 해운대구 | 경남 김해시 | 30% 할증 |
| 인천→경기 | 인천 연수구 | 경기 부천시 | 30% 할증 |

### 재미 모드 테스트

| 시나리오 | 예상 결과 |
|----------|-----------|
| 동 변경 1회 | 고정 금액 × 1 할증 |
| 동 변경 3회 | 고정 금액 × 3 할증 |

### 끄기 모드 테스트

| 시나리오 | 예상 결과 |
|----------|-----------|
| 어디로 이동하든 | 할증 없음 |

---

## 검증 체크리스트

- [x] 버전 1.1.0으로 업데이트
- [x] 설정에서 지역 할증 모드 선택 가능
- [x] 리얼 모드: 시/도 경계 벗어날 때만 할증
- [x] 리얼 모드: 도시별 할증률 올바르게 적용
- [x] 리얼 모드: 서울→광명/위례 예외 처리
- [x] 재미 모드: 기존 동 변경 시 할증 유지
- [x] 끄기 모드: 할증 미적용
- [x] 모든 단위 테스트 통과 (58개 테스트)
- [x] 빌드 성공
